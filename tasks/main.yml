---
- name: Check whether the playbook can run on this OS
  fail:
    msg: "The role is not designed to run on {{ ansible_os_family }} platform.\
        Please contact support@lean-delivery.com"
  when: ansible_os_family != "RedHat" and
        ( ansible_distribution_major_version != "6" or
        ansible_distribution_major_version != "7" )

# Variable configuration.
- name: Set variables
  include_tasks: variables.yml

# Install Mysql
- name: "Choose platform based task "
  include_tasks: "{{ platform }}"
  with_first_found:
    - 'setup-{{ ansible_os_family }}.yml'
    - 'not-supported.yml'
  loop_control:
    loop_var: platform

- name: Check if MySQL packages were installed.
  set_fact:
    mysql_install_packages: "{{ (mysql_installed_packages is defined and \
        mysql_installed_packages.changed) }}"

- name: Set additional parameters in '{{ mysql_config_file }}'
  set_fact:
    "{{ item.name }}: {{ item.value }}"
  with_items:
    - "{{ additional_parameters }}"
  when: additional_parameters is defined

# Configure MySQL.
- name: Configure
  include_tasks: configure.yml

- name: Run secure installation
  include_tasks: secure-installation.yml

- name: Create databases and users
  include_tasks: databases_and_users.yml
